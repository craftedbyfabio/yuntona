<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Yuntona — Knowledge Graph</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  :root{
    --bg:#0b1121;--surface:#111a2e;--border:#1e2d4a;
    --text:#e4e8f1;--text-muted:#a8adb8;--text-dim:#4e6283;
    --accent:#c5f227;--accent-glow:rgba(197,242,39,.15);
    --red:#ef4444;--yellow:#eab308;--green:#22c55e;--cyan:#06b6d4;
    --pink:#ec4899;--purple:#a855f7;--orange:#f97316;
  }
  body{background:var(--bg);color:var(--text);font-family:'Outfit',system-ui,sans-serif;overflow:hidden;height:100vh}
  
  .graph-header{
    position:fixed;top:0;left:0;right:0;z-index:100;
    display:flex;align-items:center;justify-content:space-between;
    padding:12px 20px;
    background:rgba(11,17,33,.85);backdrop-filter:blur(12px);
    border-bottom:1px solid var(--border);
  }
  .graph-brand{display:flex;align-items:center;gap:4px}
  .graph-brand svg{filter:drop-shadow(0 0 8px rgba(204,255,0,.2))}
  .graph-brand h1{font-size:1.1rem;font-weight:700;letter-spacing:.15em;text-transform:uppercase}
  .graph-brand span{font-size:.75rem;color:var(--text-dim);margin-left:8px;font-weight:400;letter-spacing:.05em}
  
  .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .ctrl-btn{
    padding:6px 12px;border-radius:6px;border:1px solid var(--border);
    background:var(--surface);color:var(--text-muted);font-size:.7rem;
    cursor:pointer;transition:all .2s;font-family:inherit;letter-spacing:.03em;
  }
  .ctrl-btn:hover,.ctrl-btn.active{border-color:var(--accent);color:var(--accent);background:rgba(197,242,39,.05)}
  .ctrl-group{display:flex;gap:4px;flex-wrap:wrap}
  .ctrl-label{font-size:.6rem;color:var(--text-dim);text-transform:uppercase;letter-spacing:.1em;margin-right:4px;align-self:center}
  
  #graph{width:100%;height:100vh;cursor:grab}
  #graph:active{cursor:grabbing}
  
  .tooltip{
    position:fixed;pointer-events:none;z-index:200;
    background:var(--surface);border:1px solid var(--border);border-radius:8px;
    padding:10px 14px;max-width:320px;
    box-shadow:0 8px 32px rgba(0,0,0,.5);
    opacity:0;transition:opacity .15s;
    font-size:.75rem;line-height:1.5;
  }
  .tooltip.visible{opacity:1}
  .tooltip .tt-name{font-weight:600;font-size:.8rem;margin-bottom:4px;color:var(--text)}
  .tooltip .tt-cat{font-size:.65rem;color:var(--text-dim);margin-bottom:6px}
  .tooltip .tt-desc{color:var(--text-muted);font-size:.7rem}
  .tooltip .tt-badges{display:flex;flex-wrap:wrap;gap:3px;margin-top:6px}
  .tooltip .tt-tag{padding:2px 6px;border-radius:3px;font-size:.6rem;background:rgba(197,242,39,.08);color:var(--accent);border:1px solid rgba(197,242,39,.15)}
  .tooltip .tt-risk{padding:2px 6px;border-radius:3px;font-size:.6rem;font-weight:600;background:rgba(239,68,68,.1);color:var(--red);border:1px solid rgba(239,68,68,.2)}
  .tooltip .tt-stage{padding:2px 6px;border-radius:3px;font-size:.6rem;font-weight:600;background:rgba(6,182,212,.1);color:var(--cyan);border:1px solid rgba(6,182,212,.2)}
  
  .info-panel{
    position:fixed;bottom:20px;left:20px;z-index:100;
    background:rgba(17,26,46,.9);backdrop-filter:blur(8px);
    border:1px solid var(--border);border-radius:10px;
    padding:14px 18px;font-size:.7rem;color:var(--text-dim);line-height:1.6;max-width:260px;
  }
  .legend-row{display:flex;align-items:center;gap:8px;margin-bottom:4px}
  .legend-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
  .legend-ring{width:10px;height:10px;border-radius:50%;flex-shrink:0;border:2px solid;background:transparent}
  .info-title{font-size:.75rem;font-weight:600;color:var(--text);margin-bottom:8px}
  .info-sep{border:none;border-top:1px solid var(--border);margin:8px 0}
  .info-hint{font-size:.6rem;color:var(--text-dim);font-style:italic}
  
  .stats-bar{
    position:fixed;bottom:20px;right:20px;z-index:100;
    display:flex;gap:12px;
    background:rgba(17,26,46,.9);backdrop-filter:blur(8px);
    border:1px solid var(--border);border-radius:10px;
    padding:10px 16px;
  }
  .stat{text-align:center}
  .stat-val{font-size:1.1rem;font-weight:700;color:var(--accent);font-variant-numeric:tabular-nums}
  .stat-lbl{font-size:.55rem;color:var(--text-dim);text-transform:uppercase;letter-spacing:.08em}
  
  @media(max-width:768px){
    .graph-header{padding:10px 12px;flex-direction:column;gap:8px}
    .info-panel{bottom:10px;left:10px;max-width:180px;padding:10px;font-size:.6rem}
    .stats-bar{bottom:10px;right:10px;padding:8px 10px;gap:8px}
    .stat-val{font-size:.85rem}
    .ctrl-btn{padding:4px 8px;font-size:.6rem}
  }
  .view-switch{position:fixed;top:16px;right:16px;z-index:10001;display:flex;flex-direction:column;align-items:center}
  .view-switch-toggle{width:36px;height:36px;border-radius:50%;background:transparent;border:none;cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;padding:0;transition:transform .2s}
  .view-switch-toggle:hover{transform:scale(1.1)}
  .view-switch-toggle .dot{width:5px;height:5px;border-radius:50%;background:#c5f227;transition:box-shadow .2s}
  .view-switch-toggle:hover .dot{box-shadow:0 0 8px rgba(197,242,39,.6)}
  .view-switch-menu{position:absolute;top:42px;right:0;background:rgba(17,26,46,.95);backdrop-filter:blur(12px);border:1px solid #1e2d4a;border-radius:10px;padding:6px;min-width:160px;opacity:0;visibility:hidden;transform:translateY(-8px);transition:all .2s}
  .view-switch-menu.open{opacity:1;visibility:visible;transform:translateY(0)}
  .view-switch-menu a{display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:7px;text-decoration:none;color:#a8adb8;font-size:.78rem;font-family:'Outfit',system-ui,sans-serif;transition:all .15s;white-space:nowrap}
  .view-switch-menu a:hover{background:rgba(197,242,39,.06);color:#c5f227}
  .view-switch-menu a.active{color:#c5f227;font-weight:500}
  .view-switch-menu a svg{flex-shrink:0;opacity:.6}
  .view-switch-menu a:hover svg,.view-switch-menu a.active svg{opacity:1}
  .view-switch-menu .menu-sep{height:1px;background:#1e2d4a;margin:4px 8px}
  @media(max-width:768px){.view-switch{top:10px;right:10px}.view-switch-toggle{width:32px;height:32px}.view-switch-toggle .dot{width:4px;height:4px}}
</style>
</head>
<body>
<nav class="view-switch" aria-label="View switcher">
  <button class="view-switch-toggle" aria-label="Switch view" aria-expanded="false" id="viewSwitchBtn">
    <span class="dot"></span><span class="dot"></span><span class="dot"></span>
  </button>
  <div class="view-switch-menu" id="viewSwitchMenu">
    <a href="index.html">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
      Card Index
    </a>
    <a href="graph.html" class="active">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="6" cy="6" r="2.5"/><circle cx="18" cy="18" r="2.5"/><circle cx="18" cy="6" r="2.5"/><circle cx="6" cy="18" r="2.5"/><path d="M8.5 7.5 15.5 16.5M15.5 7.5 8.5 16.5"/></svg>
      Knowledge Graph
    </a>
  </div>
</nav>
<script>
document.addEventListener('DOMContentLoaded',()=>{
  const vsBtn=document.getElementById('viewSwitchBtn'),vsMenu=document.getElementById('viewSwitchMenu');
  if(!vsBtn||!vsMenu)return;
  vsBtn.addEventListener('click',e=>{e.stopPropagation();e.preventDefault();const open=vsMenu.classList.toggle('open');vsBtn.setAttribute('aria-expanded',open)});
  document.addEventListener('click',e=>{if(!e.target.closest('.view-switch')){vsMenu.classList.remove('open');vsBtn.setAttribute('aria-expanded','false')}});
});
</script>

<div class="graph-header">
  <div class="graph-brand">
    <svg width="28" height="28" viewBox="0 0 100 100" fill="none" role="img" aria-label="Yuntona logo">
      <path d="M42 50 L58 50 L58 90 L42 90 Z" fill="#F8FAFC"/>
      <path d="M42 50 L14 15 L32 15 L50 50 Z" fill="#F8FAFC"/>
      <path d="M58 50 L86 15 L68 15 L50 50 Z" fill="#CCFF00"/>
    </svg>
    <h1><span style="position:absolute;width:1px;height:1px;overflow:hidden;clip:rect(0,0,0,0)">Y</span>UNTONA</h1>
    <span>Knowledge Graph</span>
  </div>
  <div class="controls">
    <span class="ctrl-label">View</span>
    <div class="ctrl-group">
      <button class="ctrl-btn active" data-view="all">All</button>
      <button class="ctrl-btn" data-view="risks">LLM Risks</button>
      <button class="ctrl-btn" data-view="stages">Lifecycle</button>
    </div>
    <span class="ctrl-label" style="margin-left:8px">Category</span>
    <div class="ctrl-group" id="catFilters"></div>
    <button class="ctrl-btn" id="resetBtn">&#x27F2; Reset</button>
  </div>
</div>

<svg id="graph" role="img" aria-label="Interactive knowledge graph showing relationships between AI security tools, OWASP LLM risks, and LLMSecOps lifecycle stages"></svg>

<div class="tooltip" id="tooltip"></div>

<div class="info-panel" role="complementary" aria-label="Graph legend">
  <div class="info-title">Node Types</div>
  <div class="legend-row"><div class="legend-dot" style="background:var(--accent)"></div><span>Tools (coloured by category)</span></div>
  <div class="legend-row"><div class="legend-ring" style="border-color:var(--red)"></div><span>LLM Risks (OWASP Top 10)</span></div>
  <div class="legend-row"><div class="legend-ring" style="border-color:var(--cyan)"></div><span>Lifecycle Stages</span></div>
  <hr class="info-sep">
  <div class="info-hint">Click node to highlight connections. Drag to reposition. Scroll to zoom.</div>
</div>

<div class="stats-bar" role="status" aria-label="Graph statistics">
  <div class="stat"><div class="stat-val" id="nodeCount">0</div><div class="stat-lbl">Nodes</div></div>
  <div class="stat"><div class="stat-val" id="edgeCount">0</div><div class="stat-lbl">Edges</div></div>
  <div class="stat"><div class="stat-val" id="toolCount">0</div><div class="stat-lbl">Tools</div></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.9.0/d3.min.js"></script>
<script>
const catColors = {
  'AI Red Teaming':'#ef4444','AI Governance & Standards':'#eab308',
  'AI Guardrails & Firewalls':'#22c55e','AI Development Tools':'#06b6d4',
  'AI Code Assistants':'#ec4899','Foundation Models':'#a855f7',
  'Identity & AppSec':'#3b82f6','Third-Party Risk':'#f97316',
  'Compliance Automation':'#14b8a6','Education & Research':'#a78bfa'
};

const riskLabels = {
  LLM01:'Prompt Injection',LLM02:'Insecure Output',LLM03:'Training Data Poisoning',
  LLM04:'Model DoS',LLM05:'Supply Chain Vulns',LLM06:'Sensitive Info Disclosure',
  LLM07:'Insecure Plugin Design',LLM08:'Excessive Agency',LLM09:'Overreliance',LLM10:'Model Theft'
};

const stageLabels = {
  scope:'Scope & Plan',augment:'Augment',develop:'Develop',test:'Test',
  release:'Release',deploy:'Deploy',operate:'Operate',monitor:'Monitor',govern:'Govern'
};

function buildGraph(tools) {
  const nodes = [], links = [], nodeMap = new Map();

  Object.keys(riskLabels).forEach(id => {
    const n = { id, label: id, fullLabel: riskLabels[id], type:'risk', color:'#ef4444' };
    nodes.push(n); nodeMap.set(id, n);
  });

  Object.keys(stageLabels).forEach(id => {
    const sid = 'stage-'+id;
    const n = { id:sid, label: stageLabels[id], type:'stage', color:'#06b6d4' };
    nodes.push(n); nodeMap.set(sid, n);
  });

  tools.forEach((t, i) => {
    const id = 'tool-'+i;
    const n = {
      id, label:t.name, type:'tool', color: catColors[t.category]||'#c5f227',
      category:t.category, desc:t.desc, tags:t.tags||[], url:t.url,
      risks:t.llm||[], stages:t.stages||[], agentic:t.agentic
    };
    nodes.push(n); nodeMap.set(id, n);

    (t.llm||[]).forEach(r => { if(nodeMap.has(r)) links.push({source:id,target:r,type:'risk'}); });
    (t.stages||[]).forEach(s => { const sid='stage-'+s; if(nodeMap.has(sid)) links.push({source:id,target:sid,type:'stage'}); });
  });

  return { nodes, links };
}

function render(tools) {
  const { nodes, links } = buildGraph(tools);
  const toolNodes = nodes.filter(n => n.type==='tool');

  document.getElementById('nodeCount').textContent = nodes.length;
  document.getElementById('edgeCount').textContent = links.length;
  document.getElementById('toolCount').textContent = toolNodes.length;

  // Category filter buttons
  const cats = [...new Set(toolNodes.map(n => n.category))].sort();
  const catEl = document.getElementById('catFilters');
  catEl.innerHTML = '<button class="ctrl-btn active" data-cat="all">All</button>' +
    cats.map(c => `<button class="ctrl-btn" data-cat="${c}">${c.replace('AI ','').replace('& ','')}</button>`).join('');

  const W = window.innerWidth, H = window.innerHeight;
  const svg = d3.select('#graph').attr('width',W).attr('height',H);
  svg.selectAll('*').remove();

  // Glow filters
  const defs = svg.append('defs');
  ['glow','strongGlow'].forEach((name,i) => {
    const f = defs.append('filter').attr('id',name);
    f.append('feGaussianBlur').attr('stdDeviation', i===0?3:6).attr('result','blur');
    const merge = f.append('feMerge');
    merge.append('feMergeNode').attr('in','blur');
    merge.append('feMergeNode').attr('in','SourceGraphic');
  });

  const container = svg.append('g');
  const zoomBehavior = d3.zoom().scaleExtent([0.15,5]).on('zoom', e => container.attr('transform',e.transform));
  svg.call(zoomBehavior);

  // Simulation
  const sim = d3.forceSimulation(nodes)
    .force('link', d3.forceLink(links).id(d=>d.id).distance(d => d.type==='risk'?130:110).strength(0.25))
    .force('charge', d3.forceManyBody().strength(d => d.type==='risk'?-500:d.type==='stage'?-400:-120))
    .force('center', d3.forceCenter(W/2,H/2))
    .force('collision', d3.forceCollide().radius(d => d.type==='risk'?32:d.type==='stage'?28:12))
    .force('x', d3.forceX(W/2).strength(0.025))
    .force('y', d3.forceY(H/2).strength(0.025));

  // Links
  const link = container.append('g').selectAll('line').data(links).enter().append('line')
    .attr('stroke', d => d.type==='risk'?'rgba(239,68,68,.1)':'rgba(6,182,212,.1)')
    .attr('stroke-width', 0.6);

  // Nodes
  const node = container.append('g').selectAll('g').data(nodes).enter().append('g')
    .attr('cursor','pointer')
    .call(d3.drag().on('start',(e,d)=>{if(!e.active)sim.alphaTarget(0.3).restart();d.fx=d.x;d.fy=d.y})
      .on('drag',(e,d)=>{d.fx=e.x;d.fy=e.y})
      .on('end',(e,d)=>{if(!e.active)sim.alphaTarget(0);d.fx=null;d.fy=null}));

  // Risk nodes
  node.filter(d=>d.type==='risk').append('circle').attr('r',24)
    .attr('fill','rgba(239,68,68,.06)').attr('stroke','#ef4444').attr('stroke-width',2).attr('filter','url(#glow)');
  node.filter(d=>d.type==='risk').append('text').text(d=>d.label)
    .attr('text-anchor','middle').attr('dy','.35em')
    .attr('font-size','8px').attr('font-weight','700').attr('font-family','JetBrains Mono,monospace').attr('fill','#ef4444');

  // Stage nodes
  node.filter(d=>d.type==='stage').append('circle').attr('r',22)
    .attr('fill','rgba(6,182,212,.06)').attr('stroke','#06b6d4').attr('stroke-width',2).attr('filter','url(#glow)');
  node.filter(d=>d.type==='stage').append('text').text(d=>d.label)
    .attr('text-anchor','middle').attr('dy','.35em')
    .attr('font-size','6px').attr('font-weight','600').attr('font-family','Outfit,system-ui').attr('fill','#06b6d4');

  // Tool nodes
  node.filter(d=>d.type==='tool').append('circle')
    .attr('r', d=>d.agentic?7:5)
    .attr('fill',d=>d.color).attr('fill-opacity',.65)
    .attr('stroke',d=>d.color).attr('stroke-width',d=>d.agentic?1.5:.5).attr('stroke-opacity',.35);

  // Tool labels (hidden by default)
  node.filter(d=>d.type==='tool').append('text')
    .text(d=>d.label.length>22?d.label.slice(0,20)+'…':d.label)
    .attr('x',10).attr('dy','.35em').attr('font-size','6px')
    .attr('font-family','Outfit,system-ui').attr('fill',d=>d.color)
    .attr('fill-opacity',0).attr('class','tool-label');

  // Tooltip
  const tt = document.getElementById('tooltip');

  node.on('mouseover',(event,d) => {
    if(d.type==='tool'){
      tt.innerHTML=`<div class="tt-name">${d.label}</div><div class="tt-cat">${d.category}</div>
        <div class="tt-desc">${d.desc}</div><div class="tt-badges">
        ${d.risks.map(r=>`<span class="tt-risk">${r}</span>`).join('')}
        ${d.stages.map(s=>`<span class="tt-stage">${stageLabels[s]||s}</span>`).join('')}
        ${d.tags.slice(0,4).map(t=>`<span class="tt-tag">${t}</span>`).join('')}</div>`;
    } else if(d.type==='risk'){
      const ct=links.filter(l=>(l.target.id||l.target)===d.id||(l.source.id||l.source)===d.id).length;
      tt.innerHTML=`<div class="tt-name">${d.label} — ${d.fullLabel}</div><div class="tt-desc">OWASP LLM Top 10 risk. Connected to ${ct} tools.</div>`;
    } else {
      const ct=links.filter(l=>(l.target.id||l.target)===d.id||(l.source.id||l.source)===d.id).length;
      tt.innerHTML=`<div class="tt-name">${d.label}</div><div class="tt-desc">LLMSecOps lifecycle stage. Connected to ${ct} tools.</div>`;
    }
    tt.classList.add('visible');

    // Show label on hover for tools
    if(d.type==='tool') d3.select(event.currentTarget).select('.tool-label').transition().duration(150).attr('fill-opacity',.9);
  })
  .on('mousemove',(event)=>{
    let x=event.clientX+15,y=event.clientY-10;
    if(x+320>window.innerWidth) x=event.clientX-330;
    if(y+200>window.innerHeight) y=event.clientY-200;
    tt.style.left=x+'px'; tt.style.top=y+'px';
  })
  .on('mouseout',(event,d)=>{
    tt.classList.remove('visible');
    if(d.type==='tool' && !selectedNode) d3.select(event.currentTarget).select('.tool-label').transition().duration(150).attr('fill-opacity',0);
  });

  // Click highlight
  let selectedNode = null;

  node.on('click',(event,d)=>{
    event.stopPropagation();
    if(selectedNode===d.id){ resetHL(); return; }
    selectedNode=d.id;

    const conn=new Set([d.id]);
    links.forEach(l=>{
      const s=l.source.id||l.source, t=l.target.id||l.target;
      if(s===d.id)conn.add(t); if(t===d.id)conn.add(s);
    });

    node.select('circle').transition().duration(300)
      .attr('fill-opacity',n=>conn.has(n.id)?(n.type==='tool'?.9:undefined):.04)
      .attr('stroke-opacity',n=>conn.has(n.id)?1:.04);

    node.selectAll('.tool-label').transition().duration(300)
      .attr('fill-opacity',n=>conn.has(n.id)?.85:0);

    node.filter(n=>n.type!=='tool').select('text').transition().duration(300)
      .attr('fill-opacity',n=>conn.has(n.id)?1:.08);

    link.transition().duration(300)
      .attr('stroke',l=>{
        const s=l.source.id,t=l.target.id;
        if(conn.has(s)&&conn.has(t)) return l.type==='risk'?'rgba(239,68,68,.55)':'rgba(6,182,212,.55)';
        return 'rgba(255,255,255,.015)';
      })
      .attr('stroke-width',l=>{
        const s=l.source.id,t=l.target.id;
        return(conn.has(s)&&conn.has(t))?2:.3;
      });

    d3.select(event.currentTarget).select('circle').transition().duration(300)
      .attr('filter','url(#strongGlow)').attr('stroke-width',3);
  });

  svg.on('click', resetHL);

  function resetHL(){
    selectedNode=null;
    node.select('circle').transition().duration(300)
      .attr('fill-opacity',d=>d.type==='tool'?.65:undefined)
      .attr('stroke-opacity',d=>d.type==='tool'?.35:undefined)
      .attr('filter',d=>(d.type==='risk'||d.type==='stage')?'url(#glow)':null)
      .attr('stroke-width',d=>d.type==='risk'||d.type==='stage'?2:d.agentic?1.5:.5);
    node.selectAll('.tool-label').transition().duration(300).attr('fill-opacity',0);
    node.filter(d=>d.type!=='tool').select('text').transition().duration(300).attr('fill-opacity',1);
    link.transition().duration(300)
      .attr('stroke',d=>d.type==='risk'?'rgba(239,68,68,.1)':'rgba(6,182,212,.1)')
      .attr('stroke-width',.6);
  }

  // Tick
  sim.on('tick',()=>{
    link.attr('x1',d=>d.source.x).attr('y1',d=>d.source.y).attr('x2',d=>d.target.x).attr('y2',d=>d.target.y);
    node.attr('transform',d=>`translate(${d.x},${d.y})`);
  });

  // View filters
  document.querySelectorAll('[data-view]').forEach(btn=>{
    btn.addEventListener('click',function(){
      document.querySelectorAll('[data-view]').forEach(b=>b.classList.remove('active'));
      this.classList.add('active');
      const v=this.dataset.view;
      resetHL();
      if(v==='all'){
        node.transition().duration(400).attr('opacity',1);
        link.transition().duration(400).attr('opacity',1);
      } else if(v==='risks'){
        node.transition().duration(400).attr('opacity',d=>{
          if(d.type==='risk')return 1; if(d.type==='stage')return .04;
          return d.risks&&d.risks.length>0?.75:.04;
        });
        link.transition().duration(400).attr('opacity',d=>d.type==='risk'?1:.02);
      } else {
        node.transition().duration(400).attr('opacity',d=>{
          if(d.type==='stage')return 1; if(d.type==='risk')return .04;
          return d.stages&&d.stages.length>0?.75:.04;
        });
        link.transition().duration(400).attr('opacity',d=>d.type==='stage'?1:.02);
      }
    });
  });

  // Category filter
  catEl.addEventListener('click',e=>{
    const btn=e.target.closest('[data-cat]'); if(!btn)return;
    catEl.querySelectorAll('.ctrl-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const cat=btn.dataset.cat;
    resetHL();
    if(cat==='all'){
      node.transition().duration(400).attr('opacity',1);
      link.transition().duration(400).attr('opacity',1);
    } else {
      const toolIds=new Set(), conn=new Set();
      nodes.forEach(n=>{ if(n.type==='tool'&&n.category===cat){ toolIds.add(n.id); conn.add(n.id); }});
      links.forEach(l=>{
        const s=l.source.id||l.source,t=l.target.id||l.target;
        if(toolIds.has(s))conn.add(t); if(toolIds.has(t))conn.add(s);
      });
      node.transition().duration(400).attr('opacity',d=>conn.has(d.id)?1:.03);
      link.transition().duration(400).attr('opacity',l=>{
        const s=l.source.id||l.source,t=l.target.id||l.target;
        return(toolIds.has(s)||toolIds.has(t))?.7:.015;
      });
    }
  });

  // Reset
  document.getElementById('resetBtn').addEventListener('click',()=>{
    document.querySelectorAll('[data-view]').forEach(b=>b.classList.remove('active'));
    document.querySelector('[data-view="all"]').classList.add('active');
    catEl.querySelectorAll('.ctrl-btn').forEach(b=>b.classList.remove('active'));
    catEl.querySelector('[data-cat="all"]').classList.add('active');
    resetHL();
    node.transition().duration(400).attr('opacity',1);
    link.transition().duration(400).attr('opacity',1);
    svg.transition().duration(600).call(zoomBehavior.transform,
      d3.zoomIdentity.translate(W/2,H/2).scale(.7).translate(-W/2,-H/2));
  });

  // Initial fit
  setTimeout(()=>{
    svg.transition().duration(1000).call(zoomBehavior.transform,
      d3.zoomIdentity.translate(W/2,H/2).scale(.7).translate(-W/2,-H/2));
  },600);

  // Resize
  window.addEventListener('resize',()=>{
    const w=window.innerWidth,h=window.innerHeight;
    svg.attr('width',w).attr('height',h);
    sim.force('center',d3.forceCenter(w/2,h/2)).alpha(.1).restart();
  });
}

// Load data from app.js
fetch('app.js')
  .then(r=>r.text())
  .then(src=>{
    const m=src.match(/const R=\[([\s\S]*?)\];/);
    if(!m) throw new Error('R array not found');
    const tools=new Function('return ['+m[1]+']')();
    render(tools);
  })
  .catch(err=>{
    console.error(err);
    document.body.innerHTML='<div style="padding:40px;color:#ef4444">Failed to load tool data. Ensure app.js is in the same directory.</div>';
  });
</script>
</body>
</html>
